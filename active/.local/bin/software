#!/usr/bin/env bash
set -eu

# TODO:
# (1) support for `--edit`
# (2) support for `--list`

SOFTWARE_PREFIX=~/.config/software
HOMEBREW_PREFIX=$HOME/.homebrew

# application directory
appdir="/Applications"

software()
{
  grep '\S' $SOFTWARE_PREFIX/$1 | grep -v '^#' | tr '\n' ' '
}

tap()
{
  echo "Installing homebrew taps..."
  local taps=($(software tap))

  for repo in "${taps[@]}"; do
    echo "brew tap $repo"
    brew tap $repo || true
    echo ""
  done
}

homebrew_install() {
  if [ ! -d $HOMEBREW_PREFIX ]; then
    echo "Installing homebrew..."
    curl -#fSL http://github.com/mxcl/homebrew/tarball/master | tar xz â€”strip 1 -C $HOMEBREW_PREFIX
    $HOMEBREW_PREFIX/bin/brew install git
  fi

  export PATH=$HOMEBREW_PREFIX/bin:$PATH
}

homebrew_updates() {
  echo "Updating homebrew"
  brew update && brew upgrade brew-cask
}

# install/update homebrew
homebrew_install
homebrew_updates

# brew tap
tap

echo "brew install ..."
brew install $(software brew) || true

echo "brew cask install ..."
brew cask install --appdir=$appdir $(software cask) || true

echo "npm install --global ..."
npm install --global $(software npm) || true
