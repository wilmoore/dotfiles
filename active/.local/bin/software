#!/usr/bin/env bash
set -eu

#
# Constants
#

SOFTWARE_PREFIX=~/.config/software
HOMEBREW_PREFIX=$HOME/.homebrew
APPLICATION_DIR=/Applications

#
# Convention-based installer
# npm-install--global => 'npm install --global'
#

invoke()
{
  echo "Installing software from $1"
  echo ""

  # local programs=($(grep '\S' $SOFTWARE_PREFIX/$1 | grep -v '^#' | tr '\n' ' '))
  local programs=($(grep '\S' $SOFTWARE_PREFIX/$1 | grep -v '^#'))
  local installs="$(echo $1 | sed -e 's/--/@/g' -e 's/-/ /g' -e 's/@/ --/g' -e 's/_/-/g') ${@:2}"

  for name in "${programs[@]}"; do
    local program=$(echo $name | sed 's/^!//')
    local installer=$(echo "$installs $program" | tr -s " ")
    echo "Installing $program"

    # if program exists, skip it, otherwise, intall.
    if [ -z "$(command -v $program)" ]; then
      echo $installer
      bash -c "$installer || true"
      hash -r
    else
        echo "$program: already installed...skipping!"
    fi

    echo ""
  done
}

#
# Arg Parsing
#

CMD=${1-''}

if [ "$CMD" == "--dev" ]; then
  $EDITOR $0
  exit 0
fi

if [ "$CMD" == "--edit" ]; then
  $EDITOR $SOFTWARE_PREFIX
  exit 0
fi

if [ "$CMD" == "--view" ]; then
  less $SOFTWARE_PREFIX/*
  exit 0
fi

if [ "$CMD" == "--list" ]; then
  find $SOFTWARE_PREFIX -type f
  exit 0
fi

if [ "$CMD" == "--upgrade" ]; then
  brew update
  brew upgrade --all
  exit 0
fi

#
# main
#

# install homebrew
if [ ! -d $HOMEBREW_PREFIX ]; then
  echo "Installing homebrew..."
  curl -#fSL http://github.com/mxcl/homebrew/tarball/master | tar xz â€”strip 1 -C $HOMEBREW_PREFIX
  $HOMEBREW_PREFIX/bin/brew install git
fi

# set homebrew bin path
export PATH=$HOMEBREW_PREFIX/bin:$PATH

# update homebrew
echo "Updating homebrew"
brew update

# software installations
invoke brew-tap
invoke brew-install
invoke npm-install--global
invoke rbenv-install --skip-existing
invoke brew-cask-install --appdir=$APPLICATION_DIR

# cleanup
brew cleanup
brew cask cleanup
brew prune
