#!/usr/bin/env bash
set -eu

#
# Constants
#

SOFTWARE_PREFIX=~/.config/software
HOMEBREW_PREFIX=$HOME/.homebrew
APPLICATION_DIR=/Applications

#
# Arg Parsing
#

CMD=${1-''}

if [ "$CMD" == "--edit" ]; then
  $EDITOR $SOFTWARE_PREFIX
  exit 0
fi

if [ "$CMD" == "--view" ]; then
  less $SOFTWARE_PREFIX/*
  exit 0
fi

if [ "$CMD" == "--list" ]; then
  find $SOFTWARE_PREFIX -type f
  exit 0
fi

#
# Convention-based installer
# npm-install--global => 'npm install --global'
#

invoke()
{
  echo "Installing software from $1"
  local names=($(grep '\S' $SOFTWARE_PREFIX/$1 | grep -v '^#' | tr '\n' ' '))
  local command="$(echo $1 | sed -e 's/--/@/g' -e 's/-/ /g' -e 's/@/ --/g') ${@:2}"

  for name in "${names[@]}"; do
    echo "$command $name"
    eval "$command $name || true"
    echo ""
  done
}

# install homebrew
if [ ! -d $HOMEBREW_PREFIX ]; then
  echo "Installing homebrew..."
  curl -#fSL http://github.com/mxcl/homebrew/tarball/master | tar xz â€”strip 1 -C $HOMEBREW_PREFIX
  $HOMEBREW_PREFIX/bin/brew install git
fi

# set homebrew bin path
export PATH=$HOMEBREW_PREFIX/bin:$PATH

# update homebrew
echo "Updating homebrew"
brew update

invoke brew-tap
invoke brew-install
invoke brew-cask-install --appdir=$APPLICATION_DIR
invoke npm-install--global
